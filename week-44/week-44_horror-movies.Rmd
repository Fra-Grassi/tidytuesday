---
title: "week-44_horror-movies"
author: "Francesco Grassi"
date: "2022-11-04"
output: 
  html_document:
    toc: true
    toc_depth: 2
    fig_retina: 1
---

<style type="text/css">
.main-container {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
options(dplyr.summarise.inform = FALSE)
```

# Aim

Play around and make some nice plot out of the big data-set of ~35K horror movies from The Movie Database.  
Here's the plan:

- Prepare the data
- Plot top 3 movies per decade, based on average rating

# Libraries
```{r, message=FALSE}
library(tidytuesdayR)
library(tidyverse)
library(tidytext)
library(stringr)
library(lubridate)
library(colorspace)  # modify colors
library(scales)  # custom axis scales
library(showtext)  # customize font in plots

# Add font to use in plots:
sysfonts::font_add(family = "Libre Baskerville", 
                   regular = "LibreBaskerville-Regular.ttf",
                   italic = "LibreBaskerville-Italic.ttf",
                   bold = "LibreBaskerville-Bold.ttf")

showtext_auto()
```

# Prepare data

## Load data
```{r, message=FALSE}

# tuesdata <- tidytuesdayR::tt_load(2022, week = 44)  # Load datasets
# raw_data <- tuesdata$horror_movies
# write_csv(raw_data, file = "data/raw-data.csv")
raw_data <- read_csv(file = "data/raw-data.csv")

```

## Clean and prepare data

First, we will focus only on movies which have been released, so we will filter them for "status".  
We also want to extract the decade each movie was released from the release data variable. This might turn useful in many plots

```{r}
main_df <- raw_data %>% 
  filter(status == "Released") %>% 
  mutate(decade = year(release_date) - year(release_date)%%10)  # find decade (maybe not the most elegant way)
```

# Plots

## Plot settings

Let's define some settings to keep plots coherent:
```{r}

color_title <- "#B1281E"  # title color
color_background <- "#0D0506"  # background color

# Settings for plot text:
title_size <- 40
axis_title_size <- 22
axis_label_size <- 12
legend_title_size <- 22
legend_text_size <- 12
strip_size <- 22  # text size for facet labels

# Settings for output images:
figure_width <- 20
figure_height <- 14
figure_unit <- "in"
figure_dpi <- 300

```

## Top 3 movies per decade

### Select data

We should keep in mind that many movies have a very high average score, but were rated by only one or very few people. This would lead to very distorted results. Therefore, let's select the highest rated movies only among the top 1% by vote count within each decade.  
Moreover, we will use vote count also to break possible ties.  
Therefore, one way to go (maybe not the most elegant one) is to select the top 1% movies by vote count within each decade. Then, order the movies by vote average, and *within* it, by vote count. This way, by selecting the first 3 rows per decade, we'll select the highest rated movies and will break ties based on highest vote count.

```{r}
p <- main_df %>% 
  group_by(decade) %>% 
  filter(vote_count > quantile(vote_count, .99)) %>%  # select top 1%
  arrange(desc(vote_average), desc(vote_count), .by_group = TRUE) %>%  # "arrange()" must be told explicitly to keep groups into account 
  slice_head(n = 3)  # select top 3 movies
```

### Plot

It's finally possible to plot the selected data. We can use a bar plot, and facet by decade. Let's also add the average vote on top of each column.

```{r, fig.width=20, fig.height=14}

p %>% mutate(title = factor(title, levels = unique(title))) %>%  # prevent movies to be arranged by title
  ggplot(aes(x = title, y = vote_average)) +
  geom_col(fill = color_title) +
  geom_text(aes(label = vote_average), vjust = -0.5, color = "white", family = "Libre Baskerville", size = axis_title_size/.pt) +
  scale_x_discrete(labels = wrap_format(15)) +  # wrap long titles
  scale_y_continuous(limits = c(0, 9), breaks = 0:9, labels = 0:9 ) +
  facet_wrap(~ decade, nrow = 2, scales = "free_x") +
  labs(title = "Top 3 Horror Movies per Decade",
       y = "Average Score") +
  theme_minimal() +
  theme(
    text = element_text(family = "Libre Baskerville", face = "bold"),
    plot.title = element_text(size = title_size, color = color_title),
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = axis_title_size, color = color_title),
    axis.text = element_text(size = axis_label_size, color = color_title),
    strip.text = element_text(size = strip_size, color = color_title),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey30"),
    panel.grid.minor = element_blank(),
    panel.spacing.y = unit(1.5, "lines"),  # change spacing between facets
    plot.background = element_rect(fill = color_background),
    plot.margin = margin(20, 20, 10, 10)  # adjust margins of plotting area
  )

showtext_auto(FALSE)
ggsave(file = "img/top_3_votes.png", dpi = figure_dpi, width = figure_width, height = figure_height, units = figure_unit, bg = "white")
```

